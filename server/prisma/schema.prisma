// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums matching types.ts (As strings for SQLite support)

// Models

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String
  name              String
  roleId            String?
  role              Role?     @relation(fields: [roleId], references: [id])
  // Legacy string role for backward compatibility during migration
  roleString        String    @default("INTERNAL_COUNSEL") @map("role")
  
  region            String    @default("GH_ACC_1")
  
  // Relations
  tenantId          String?
  tenant            Tenant?   @relation(fields: [tenantId], references: [id])
  assignedMatters   Matter[]
  timeEntries       TimeEntry[]
  auditLogs         AuditLog[]

  createdAt         DateTime  @default(now())
  attributes        Json?     @default("{}")
  updatedAt         DateTime  @updatedAt

  // OIDC / Federation
  provider          String    @default("LOCAL")
  providerId        String?
}

model Role {
  id          String       @id @default(uuid())
  name        String       @unique // e.g., "TENANT_ADMIN"
  description String?
  isSystem    Boolean      @default(false) // System roles cannot be deleted
  
  users       User[]
  permissions Permission[]
  policies    Policy[]

  tenantId    String?      // Null = Global Role, Set = Custom Tenant Role
  tenant      Tenant?      @relation(fields: [tenantId], references: [id])
}

model Permission {
  id          String       @id // e.g., "MATTER_CREATE"
  description String
  resource    String       // e.g., "MATTER"
  action      String       // e.g., "CREATE"
  
  roles       Role[]
}

model Policy {
  id          String   @id @default(uuid())
  name        String
  description String?
  effect      String   @default("DENY") // ALLOW or DENY
  resource    String   // e.g. "MATTER", "AI_MODEL"
  action      String   // e.g. "EXECUTE", "VIEW"
  condition   String?  // JSON Logic string
  priority    Int      @default(0)

  roles       Role[]   // Roles this policy applies to
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Tenant {
  id                String    @id @default(uuid())
  name              String
  plan              String    @default("STANDARD")
  appMode           String    @default("LAW_FIRM") // "LAW_FIRM" or "ENTERPRISE"
  primaryRegion     String    @default("GH_ACC_1")
  
  users             User[]
  roles             Role[]
  matters           Matter[]
  policies          Policy[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model Matter {
  id                String    @id @default(uuid())
  name              String
  client            String
  type              String
  status            String    @default("OPEN")
  riskLevel         String    @default("LOW")
  description       String?
  
  attributes        Json?     @default("{}")

  // Relations
  tenantId          String
  tenant            Tenant    @relation(fields: [tenantId], references: [id])
  internalCounselId String
  internalCounsel   User      @relation(fields: [internalCounselId], references: [id])
  
  documents         Document[]
  timeEntries       TimeEntry[]
  risks             PredictiveRisk[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model Document {
  id                String    @id @default(uuid())
  name              String
  uri               String    // Path to blob storage
  jurisdiction      String
  privilege         String    @default("INTERNAL")
  classification    String    @default("Confidential")

  attributes        Json?     @default("{}")
  
  matterId          String
  matter            Matter    @relation(fields: [matterId], references: [id])

  lastReviewed      DateTime  @default(now())
  createdAt         DateTime  @default(now())
}

model TimeEntry {
  id                String    @id @default(uuid())
  description       String
  durationMinutes   Int
  startTime         DateTime
  isBillable        Boolean   @default(true)
  status            String    @default("Draft")

  matterId          String
  matter            Matter    @relation(fields: [matterId], references: [id])
  userId            String
  user              User      @relation(fields: [userId], references: [id])
}

model PredictiveRisk {
  id                String    @id @default(uuid())
  type              String
  probability       Float
  impact            String
  description       String

  matterId          String
  matter            Matter    @relation(fields: [matterId], references: [id])
}

model AuditLog {
  id                String    @id @default(uuid())
  action            String
  timestamp         DateTime  @default(now())
  
  userId            String?
  user              User?     @relation(fields: [userId], references: [id])
  
  details           String?   // JSON string
  ipAddress         String?
  resourceId        String?
}

model KnowledgeArtifact {
  id          String   @id @default(uuid())
  title       String
  content     String
  category    String
  sourceUri   String
  lastIndexed DateTime @default(now())

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model RegulatoryRule {
  id              String   @id @default(uuid())
  name            String
  authority       String
  triggerKeywords String[]
  blockThreshold  Float
  description     String
  isActive        Boolean  @default(true)
  region          String? 
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
