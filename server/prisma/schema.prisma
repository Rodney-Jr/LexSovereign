// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums matching types.ts (As strings for SQLite support)

// Models

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String
  name              String
  roleId            String?
  role              Role?     @relation(fields: [roleId], references: [id])
  // Legacy string role for backward compatibility during migration
  roleString        String    @default("INTERNAL_COUNSEL") @map("role")
  
  region            String    @default("GH_ACC_1")
  
  // Relations
  tenantId          String?
  tenant            Tenant?   @relation(fields: [tenantId], references: [id])
  assignedMatters   Matter[]
  timeEntries       TimeEntry[]
  auditLogs         AuditLog[]

  createdAt         DateTime  @default(now())
  attributes        Json?     @default("{}")
  updatedAt         DateTime  @updatedAt

  // OIDC / Federation
  provider          String    @default("LOCAL")
  providerId        String?

  // Password Reset
  resetToken        String?   @unique
  resetTokenExpires DateTime?

  // People & Capacity
  maxWeeklyHours    Float     @default(40.0)
  roleSeniority     Float     @default(1.0)
  jurisdictionPins  Json?     @default("[]")
  credentials       Json?     @default("[]")
  
  isActive          Boolean   @default(true)
}

model Role {
  id          String       @id @default(uuid())
  name        String       // e.g., "TENANT_ADMIN"
  description String?
  isSystem    Boolean      @default(false) // System roles cannot be deleted
  
  users       User[]
  permissions Permission[]
  policies    Policy[]

  tenantId    String?      // Null = Global Role, Set = Custom Tenant Role
  tenant      Tenant?      @relation(fields: [tenantId], references: [id])

  @@unique([name, tenantId])
}

model Permission {
  id          String       @id // e.g., "MATTER_CREATE"
  description String
  resource    String       // e.g., "MATTER"
  action      String       // e.g., "CREATE"
  
  roles       Role[]
}

model Policy {
  id          String   @id @default(uuid())
  name        String
  description String?
  effect      String   @default("DENY") // ALLOW or DENY
  resource    String   // e.g. "MATTER", "AI_MODEL"
  action      String   // e.g. "EXECUTE", "VIEW"
  condition   String?  // JSON Logic string
  priority    Int      @default(0)

  roles       Role[]   // Roles this policy applies to
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Tenant {
  id                String    @id @default(uuid())
  name              String
  plan              String    @default("STANDARD")
  appMode           String    @default("LAW_FIRM") // "LAW_FIRM" or "ENTERPRISE"
  primaryRegion     String    @default("GH_ACC_1")
  
  encryptionMode    String    @default("SYSTEM_MANAGED") // "SYSTEM_MANAGED" or "BYOK"
  
  users             User[]
  roles             Role[]
  matters           Matter[]
  policies          Policy[]
  invitations       Invitation[]
  brandingProfiles  BrandingProfile[]
  chatbotConfig     ChatbotConfig?
  status            String    @default("ACTIVE") // ACTIVE, SUSPENDED, DELETED

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model ChatbotConfig {
  id                String   @id @default(uuid())
  tenantId          String   @unique
  tenant            Tenant   @relation(fields: [tenantId], references: [id])
  
  botName           String
  welcomeMessage    String
  isEnabled         Boolean  @default(true)
  channels          Json     // { whatsapp: boolean, webWidget: boolean }
  knowledgeBaseIds  Json     // String[]
  systemInstruction String
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Matter {
  id                String    @id @default(uuid())
  name              String
  client            String
  type              String
  status            String    @default("OPEN")
  riskLevel         String    @default("LOW")
  description       String?
  complexityWeight  Float     @default(5.0)
  attributes        Json?     @default("{}")

  // Relations
  tenantId          String
  tenant            Tenant    @relation(fields: [tenantId], references: [id])
  internalCounselId String
  internalCounsel   User      @relation(fields: [internalCounselId], references: [id])
  
  documents         Document[]
  timeEntries       TimeEntry[]
  risks             PredictiveRisk[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model Document {
  id                String    @id @default(uuid())
  name              String
  uri               String    // Path to blob storage
  jurisdiction      String
  privilege         String    @default("INTERNAL")
  classification    String    @default("Confidential")

  attributes        Json?     @default("{}")
  
  matterId          String
  matter            Matter    @relation(fields: [matterId], references: [id])

  // Metadata for Optional BYOK
  encryptionKeyId   String?   // External ID for BYOK
  isEncrypted       Boolean   @default(false)
  encryptionIV      String?   // Base64 IV for AES-GCM

  lastReviewed      DateTime  @default(now())
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt @default(now())
}

model TimeEntry {
  id                String    @id @default(uuid())
  description       String
  durationMinutes   Int
  startTime         DateTime
  isBillable        Boolean   @default(true)
  status            String    @default("Draft")

  matterId          String
  matter            Matter    @relation(fields: [matterId], references: [id])
  userId            String
  user              User      @relation(fields: [userId], references: [id])
}

model PredictiveRisk {
  id                String    @id @default(uuid())
  type              String
  probability       Float
  impact            String
  description       String

  matterId          String
  matter            Matter    @relation(fields: [matterId], references: [id])
}

model AuditLog {
  id                String    @id @default(uuid())
  action            String
  timestamp         DateTime  @default(now())
  
  userId            String?
  user              User?     @relation(fields: [userId], references: [id])
  
  details           String?   // JSON string
  ipAddress         String?
  resourceId        String?
}

model KnowledgeArtifact {
  id          String   @id @default(uuid())
  title       String
  content     String
  category    String
  sourceUri   String
  lastIndexed DateTime @default(now())

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Invitation {
  id          String   @id @default(uuid())
  token       String   @unique
  email       String
  roleName    String
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  isUsed      Boolean  @default(false)
  expiresAt   DateTime
  createdAt   DateTime @default(now())
}

model DocumentTemplate {
  id              String   @id @default(uuid())
  name            String
  description     String
  category        String   // e.g. "CORPORATE", "LITIGATION", "REAL_ESTATE"
  jurisdiction    String   // e.g. "GH_ACC_1", "GLOBAL"
  content         String   // The markdown/liquid skeleton content
  structure       Json     // Rich JSON schema for fields and sections
  version         String   @default("1.0.0")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model RegulatoryRule {
  id              String   @id @default(uuid())
  name            String
  authority       String
  triggerKeywords String[]
  blockThreshold  Float
  description     String
  isActive        Boolean  @default(true)
  region          String? 
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
model PricingConfig {
  id              String   @id // e.g. "STANDARD", "SOVEREIGN", "ENCLAVE"
  basePrice       Float
  pricePerUser    Float
  creditsIncluded Int      @default(0)
  maxUsers        Int      @default(5)
  features        Json     // Array of strings
  updatedAt       DateTime @updatedAt
}

model BrandingProfile {
  id                String   @id @default(uuid())
  name              String
  logoUrl           String?
  primaryColor      String   @default("#4F46E5")
  secondaryColor    String   @default("#6366F1")
  primaryFont       String   @default("Times New Roman")
  headerText        String?
  footerText        String?
  coverPageEnabled  Boolean  @default(false)
  watermarkText     String?
  version           Int      @default(1)

  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id])

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Lead {
  id        String   @id @default(uuid())
  email     String
  name      String
  company   String?
  status    String   @default("NEW") // NEW, CONTACTED, CONVERTED, ARCHIVED
  source    String   @default("WEB_MODAL") // WEB_MODAL, CHATBOT

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model GazetteEmbedding {
  id              String   @id @default(uuid())
  region          String   // GH, NG, KE
  title           String
  contentChunk    String   // The text excerpt
  embedding       Json?    // Standard JSON storage for raw embeddings
  sourceUrl       String?  // Reference to original PDF
  metadata        Json?    @default("{}")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([region])
}

model DailyFxRate {
  id            String   @id @default(uuid())
  currencyPair  String   // e.g. "USD_GHS", "GBP_GHS"
  rate          Float
  provider      String   @default("EXCHANGERATE_API")
  
  effectiveDate DateTime // The date the rate is valid for
  capturedAt    DateTime @default(now())

  @@unique([currencyPair, effectiveDate])
}
