generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String      @id @default(uuid())
  email             String      @unique
  passwordHash      String
  name              String
  roleString        String      @default("INTERNAL_COUNSEL") @map("role")
  region            String      @default("GH_ACC_1")
  tenantId          String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  attributes        Json?       @default("{}")
  provider          String      @default("LOCAL")
  providerId        String?
  roleId            String?
  resetToken        String?     @unique
  resetTokenExpires DateTime?
  credentials       Json?       @default("[]")
  jurisdictionPins  Json?       @default("[]")
  maxWeeklyHours    Float       @default(40.0)
  roleSeniority     Float       @default(1.0)
  isActive          Boolean     @default(true)
  department        String?
  auditLogs         AuditLog[]
  assignedMatters   Matter[]
  timeEntries       TimeEntry[]
  role              Role?       @relation(fields: [roleId], references: [id])
  tenant            Tenant?     @relation(fields: [tenantId], references: [id])
}

model Role {
  id          String       @id @default(uuid())
  name        String
  description String?
  isSystem    Boolean      @default(false)
  tenantId    String?
  tenant      Tenant?      @relation(fields: [tenantId], references: [id])
  users       User[]
  permissions Permission[] @relation("PermissionToRole")
  policies    Policy[]     @relation("PolicyToRole")

  @@unique([name, tenantId])
}

model Permission {
  id          String @id
  description String
  resource    String
  action      String
  roles       Role[] @relation("PermissionToRole")
}

model Policy {
  id          String   @id @default(uuid())
  name        String
  description String?
  effect      String   @default("DENY")
  resource    String
  action      String
  condition   String?
  priority    Int      @default(0)
  tenantId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  roles       Role[]   @relation("PolicyToRole")
}

model Tenant {
  id               String            @id @default(uuid())
  name             String
  plan             String            @default("STANDARD")
  primaryRegion    String            @default("GH_ACC_1")
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  appMode          String            @default("LAW_FIRM")
  encryptionMode   String            @default("SYSTEM_MANAGED")
  status           String            @default("ACTIVE")
  separationMode   String            @default("OPEN")
  brandingProfiles BrandingProfile[]
  chatbotConfig    ChatbotConfig?
  invitations      Invitation[]
  matters          Matter[]
  policies         Policy[]
  roles            Role[]
  users            User[]
}

model ChatbotConfig {
  id                String   @id @default(uuid())
  tenantId          String   @unique
  botName           String
  welcomeMessage    String
  isEnabled         Boolean  @default(true)
  channels          Json
  knowledgeBaseIds  Json
  systemInstruction String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  tenant            Tenant   @relation(fields: [tenantId], references: [id])
}

model Matter {
  id                String           @id @default(uuid())
  name              String
  client            String
  type              String
  status            String           @default("OPEN")
  riskLevel         String           @default("LOW")
  description       String?
  tenantId          String
  internalCounselId String
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  attributes        Json?            @default("{}")
  complexityWeight  Float            @default(5.0)
  department        String?
  documents         Document[]
  internalCounsel   User             @relation(fields: [internalCounselId], references: [id])
  tenant            Tenant           @relation(fields: [tenantId], references: [id])
  risks             PredictiveRisk[]
  timeEntries       TimeEntry[]
}

model Document {
  id              String   @id @default(uuid())
  name            String
  uri             String
  jurisdiction    String
  privilege       String   @default("INTERNAL")
  classification  String   @default("Confidential")
  matterId        String
  lastReviewed    DateTime @default(now())
  createdAt       DateTime @default(now())
  attributes      Json?    @default("{}")
  encryptionKeyId String?
  isEncrypted     Boolean  @default(false)
  encryptionIV    String?
  updatedAt       DateTime @default(now()) @updatedAt
  matter          Matter   @relation(fields: [matterId], references: [id])
}

model TimeEntry {
  id              String   @id @default(uuid())
  description     String
  durationMinutes Int
  startTime       DateTime
  isBillable      Boolean  @default(true)
  status          String   @default("Draft")
  matterId        String
  userId          String
  matter          Matter   @relation(fields: [matterId], references: [id])
  user            User     @relation(fields: [userId], references: [id])
}

model PredictiveRisk {
  id          String @id @default(uuid())
  type        String
  probability Float
  impact      String
  description String
  matterId    String
  matter      Matter @relation(fields: [matterId], references: [id])
}

model AuditLog {
  id         String   @id @default(uuid())
  action     String
  timestamp  DateTime @default(now())
  userId     String?
  details    String?
  ipAddress  String?
  resourceId String?
  user       User?    @relation(fields: [userId], references: [id])
}

model KnowledgeArtifact {
  id          String   @id @default(uuid())
  title       String
  content     String
  category    String
  sourceUri   String
  lastIndexed DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Invitation {
  id        String   @id @default(uuid())
  token     String   @unique
  email     String
  roleName  String
  tenantId  String
  isUsed    Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
}

model DocumentTemplate {
  id           String   @id @default(uuid())
  name         String
  description  String
  category     String
  jurisdiction String
  content      String
  version      String   @default("1.0.0")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  structure    Json
}

model RegulatoryRule {
  id              String   @id @default(uuid())
  name            String
  authority       String
  triggerKeywords String[]
  blockThreshold  Float
  description     String
  isActive        Boolean  @default(true)
  region          String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model PricingConfig {
  id              String   @id
  basePrice       Float
  pricePerUser    Float
  creditsIncluded Int      @default(0)
  features        Json
  updatedAt       DateTime @updatedAt
  maxUsers        Int      @default(5)
}

model BrandingProfile {
  id               String   @id @default(uuid())
  name             String
  logoUrl          String?
  primaryFont      String   @default("Times New Roman")
  headerText       String?
  footerText       String?
  coverPageEnabled Boolean  @default(false)
  watermarkText    String?
  version          Int      @default(1)
  tenantId         String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  primaryColor     String   @default("#4F46E5")
  secondaryColor   String   @default("#6366F1")
  tenant           Tenant   @relation(fields: [tenantId], references: [id])
}

model Lead {
  id        String   @id @default(uuid())
  email     String
  name      String
  company   String?
  status    String   @default("NEW")
  source    String   @default("WEB_MODAL")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  phone     String?
}

model GazetteEmbedding {
  id           String   @id @default(uuid())
  region       String
  title        String
  contentChunk String
  embedding    Json?
  sourceUrl    String?
  metadata     Json?    @default("{}")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([region])
}

model DailyFxRate {
  id            String   @id @default(uuid())
  currencyPair  String
  rate          Float
  provider      String   @default("EXCHANGERATE_API")
  effectiveDate DateTime
  capturedAt    DateTime @default(now())

  @@unique([currencyPair, effectiveDate])
}

model ChatConversation {
  id           String   @id @default(uuid())
  sessionId    String
  visitorEmail String?
  visitorName  String?
  messages     Json
  source       String   @default("MARKETING_WIDGET")
  status       String   @default("ACTIVE")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  intentScore  Float    @default(0.0)
  isLead       Boolean  @default(false)
  metadata     Json?

  @@index([sessionId])
  @@index([createdAt])
  @@index([isLead])
}
